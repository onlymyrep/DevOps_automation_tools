# Инструменты автоматизации

Использование инструментов автоматизации для провизии узлов.

## Contents

1. [Chapter I](#chapter-i) 
2. [Chapter II](#chapter-ii) \
   2.1. [Удаленное конфигурирование узла через Ansible](#part-1-удаленное-конфигурирование-узла-через-ansible) \
   2.2. [Service Discovery](#part-2-service-discovery) 

## Chapter I

При разворачивании приложения на некотором узле, не важно продакшн это или тестовый стенд, необходимо подготовить саму машину к развертыванию приложения. Как вы уже знаете, docker-образ содержит в себе уже все необходимые зависимости для запуска приложения, но все же есть ряд параметров требующий дополнительной настройки или провизии (provision). Во-первых это может быть установка пакетов и инструментов (например самого docker или git), это может быть дополнительная конфигурация, зависящая от узла, перенос файлов и т. д. Именно для решения таких проблем и были созданы многие инструменты автоматизации удаленной конфигурации машин, одним из которых является **Ansible**.

В мире современных веб-приложений часто оказывается так, что сервис, доступный по одному ip-адресу был, например, перемещен на другой. В таком случае наиболее остро встает проблема ручного переконфигурирования каналов связи различных подсистем приложения, выделенных в отдельные сервисы. Эту проблему решает **Consul**, осуществляющий *Service Discovery*, который позволяет автоматизировать процесс конфигурирования каналов связи.

## Chapter II

Итогом выполненной работы должен быть отчет с подробными описаниями выполнения каждого из пунктов, подкрепленного скриншотами. Отчет формируется в виде markdown файла в директории `src` с именем `REPORT.MD`

## Part 1. Удаленное конфигурирование узла через Ansible

В этой главе вам предстоит осуществить удаленную настройку узла для разворачивания мултисервисного приложения.

**== Задание ==**

1) Создать с помощью Vagrant три машины - manager, node01, node02. Не устанавливать с помощью shell-скриптов docker при создании машин на Vagrant! Прокинуть порты node01 на локальную машину для доступа к пока еще не развернутому микросервисному приложению.

2) Подготовить manager как рабочую станцию для удаленного конфигурирования (помощь по Ansible в материалах).
- Зайти на manager. 
- На manager проверить подключение к node01 через ssh по приватной сети. 
- Сгенерировать ssh-ключ для подключения к node01 из manager (без passphrase). 
- Скопировать на manager docker-compose файл и исходный код микросервисов. (Используйте проект из папки src и docker-compose файл из предыдущей главы. Помощь по ssh материалах.)
- Установить Ansible на менеджер и создать папку ansible, в котором создать inventory-файл. 
- Использовать модуль ping для проверки подключения через Ansible. 
- Результат выполнения модуля поместить в отчет.

4) Написать первый плейбук для Ansible, который выполняет apt update, устанавливает docker, docker-compose, копирует compose-файл из manager'а и разворачивает микросервисное приложение. 

5) Прогнать заготовленные тесты через postman и удостовериться, что все они проходят успешно. В отчете отобразить результаты тестирования.

6) Сформировать три роли: 
 - роль application выполняет развертывание микросервисного приложения при помощи docker-compose,
 - appache устанавливает и запускает стандартный appache сервер
 - postgres устанавливает и запускает postgres, создает базу данных с произвольной таблицей и добавляет в нее три произвольные записи. 
 - Назначить первую роль node01 и вторые две роли node02, проверить postman-тестами работоспособность микросервсиного приложения, удостовериться в доступности postgres и apache-сервера. 

7) Созданные в этом разделе файлы разместить в папке `src\ansible01` в личном репозитории.

## Part 2. Service Discovery

Теперь перейдем к обнаружению сервисов. В этой главе вам предстоит cымитировать два удаленных сервиса - api и БД, и осуществить между ними подключение через Service Discovery с использованием Consul.

**== Задание ==**

1) Написать два конфигурационный файла для consul (информация по consul в материалах):
- consul_server.hcl:
   - настроить агент как сервер;
   - указать в advertise_addr интерфейс, направленный во внутреннюю сеть Vagrant
- consul_client.hcl:
   - настроить агент как клиент;
   - указать в advertise_addr интерфейс, направленный во внутреннюю сеть Vagrant


2) Создать с помощью Vagrant три машины - consul_server, api и db. 
- Прокинуть порт 8082 с api на локальную машину для доступа к пока еще не развернутому api
- Прокинуть порт 8500 с manager для доступа к ui consul. 
- Перенести на consul_server предварительно собранный jar-файл из исходного кода в папке `src/microservices/hotels_service` и подготовленные конфиги для consul.

3) Написать плейбук для ansible и четыре роли: 
- install_consul_server, которая:
   - работает с consul_server;
   - копирует consul_server.hcl;
   - устанавливает consul и необходимые для consul зависимости;
   - запускает сервис consul
- install_consul_client, которая:
   - работает с api и db;
   - копирует consul_server.hcl;
   - устанавливает consul, envy и необходимые для consul зависимости; 
   - запускает сервис consul и consul-envoy;
- install_db, которая:
   - работает с db;
   - устанавливает postgres и запускает его;
   - создает базу данных `hotels_db`;
- install_hotels_service, которая:
   - работает с api;
   - копирует исходный код сервиса
   - устанавлвиает `openjdk-8-jdk`
   - создает глобальные переменные окружения:
      - POSTGRES_HOST="127.0.0.1"
      - POSTGRES_PORT="5432"
      - POSTGRES_DB="hotels_db"
      - POSTGRES_USER="<имя пользователя>"
      - POSTGRES_PASSWORD="<пароль пользователя>"
   - запускает собранный jar-файл командой `java -jar <путь до hotel-service>/hotel-service/target/<имя jar-файла>.jar`

4) Прогнать заготовленные тесты через postman на хосте и удостовериться, что все они проходят успешно. В отчете отобразить результаты тестирования.

5) Созданные в этом разделе файлы разместить в папках `src\ansible02` и `src\consul01` в личном репозитории.
